<dataConfig>
  <dataSource type="JdbcDataSource" driver="com.mysql.jdbc.Driver"
    url="jdbc:mysql://<%= @db_url %>:3306/<%= @db_name %>"
    password="<%= @db_password %>"
    autoReconnect="true"
    user="<%= @db_user %>"
    name="seller_deals"
  />

  <document>
    <entity name="order" pk="order_id" dataSource="seller_deals"
        query="
         SELECT
            vd.log AS 'sold_at',
            (CASE
             WHEN (v.status = 1 AND atrasado = 1) THEN 4
             WHEN (v.status = 3 AND v.fenvio = 'local') THEN 5
             ELSE v.status
            END) AS status,
            v.order_id,
            vd.dest_nome   AS 'buyer_name',
            vd.dest_cidade AS 'delivery_city',
            vd.dest_estado AS 'delivery_state',
            vd.dest_cep    AS 'delivery_zip_code',
            v.fenvio       AS 'delivery_method',
            v.total,
            v.comprador    AS 'buyer_id',
            v.vendedor     AS 'seller_id',

            GROUP_CONCAT(vi.autor, '#-#', vi.titulo, '#-#', coalesce(vi.editora,''), '#-#', coalesce(vi.book_type,'0'), '#-#',
                         coalesce(vi.idioma, ''), '#-#', coalesce(location_in_store,' '), '#-#', coalesce(category, ' '),'#-#',
                         coalesce(vi.ano,''), '#-#', coalesce(vi.descr, ' ') SEPARATOR '----line----') as items
          FROM venda_items vi
          JOIN vendas v ON vi.order_id = v.order_id
          JOIN vendas_detalhes vd ON v.order_id = vd.order_id
          WHERE vd.log > DATE_SUB(NOW(), INTERVAL 6 MONTH)
          GROUP BY order_id"

        deltaImportQuery="
          SELECT
             vd.log AS 'sold_at',
             (CASE
              WHEN (v.status = 1 AND atrasado = 1) THEN 4
              WHEN (v.status = 3 AND v.fenvio = 'local') THEN 5
              ELSE v.status
             END) AS status,
             v.order_id,
             vd.dest_nome   AS 'buyer_name',
             vd.dest_cidade AS 'delivery_city',
             vd.dest_estado AS 'delivery_state',
             vd.dest_cep    AS 'delivery_zip_code',
             v.fenvio       AS 'delivery_method',
             v.total,
             v.comprador    AS 'buyer_id',
             v.vendedor     AS 'seller_id',

             GROUP_CONCAT(vi.autor, '#-#', vi.titulo, '#-#', coalesce(vi.editora,''), '#-#', coalesce(vi.book_type,'0'), '#-#',
                          coalesce(vi.idioma, ''), '#-#', coalesce(location_in_store,' '), '#-#', coalesce(category, ' '),'#-#',
                          coalesce(vi.ano,''), '#-#', coalesce(vi.descr, ' ') SEPARATOR '----line----') as items
           FROM venda_items vi
           JOIN vendas v ON vi.order_id = v.order_id
           JOIN vendas_detalhes vd ON v.order_id = vd.order_id
           WHERE v.order_id = '${dih.delta.order_id}'
           GROUP BY v.order_id
        "

        deltaQuery="
          SELECT v.order_id
          FROM vendas v
          WHERE DATE_ADD(v.updated_at, INTERVAL 3 HOUR) &gt; '${dih.last_index_time}'
        "
      >

      <field name="sold_at" column="sold_at" />
      <field name="status" column="status" />
      <field name="order_id" column="order_id" />
      <field name="buyer_name" column="buyer_name" />
      <field name="delivery_city" column="delivery_city" />
      <field name="delivery_state" column="delivery_state" />
      <field name="delivery_zip_code" column="delivery_zip_code" />
      <field name="delivery_method" column="delivery_method" />
      <field name="total" column="total" />
      <field name="buyer_id" column="buyer_id" />
      <field name="seller_id" column="seller_id" />
      <field name="items" column="items" />
    </entity>
  </document>
</dataConfig>
