<dataConfig>

  <dataSource type="JdbcDataSource" driver="org.postgresql.Driver"
    name="library"
    url="jdbc:postgresql://library-sg.c6orwgo57rj2.us-east-1.rds.amazonaws.com:5432/library_staging"
    user="librarysg"
    password="library-sg"
    autoReconnect="true"
  />

  <dataSource type="JdbcDataSource" driver="com.mysql.jdbc.Driver"
    name="evmain"
    url="jdbc:mysql://174.143.111.169:3306/estantevirtual"
    user="solr"
    password="RCifH0slt7"
    autoReconnect="true"
  />


  <document>

    <entity name="sku" pk="id" dataSource="library"
     query="SELECT 
              md5(concat(b.id, p.id, s.id)) as id,
              b.id book_id, b.title, b.synopsis,  md5(synopsis) md5_synopsis, b.volume, 
              p.id as publication_id, p.isbn, p.issn, p.barcode, p.edition, p.weight,
              p.height, p.width, p.depth, p.year, p.pages, pbrs.name publisher, p.created_at,
              p.updated_at, p.deleted_at, p.cover, p.isbn, p.issn, p.barcode, 
              s.id as sku, s.seller_id as seller_id, s.price,
              (CASE WHEN s.is_new is not null and s.is_new = 't' THEN 1 ELSE 0 END) new, 
              (CASE WHEN s.is_new is not null and s.is_new = 'f' THEN 1 ELSE 0 END) used,
              s.quantity, s.created_at sku_created_at
            FROM books b
            left join publications p on p.book_id = b.id
            left join skus s on s.publication_id = p.id
            left join publishers pbrs on pbrs.id = p.publisher_id"
     deltaImportQuery="SELECT md5(concat(b.id, p.id, s.id)) as id,
              b.id book_id, b.title, b.synopsis,  md5(synopsis) md5_synopsis, b.volume, 
              p.id as publication_id, p.isbn, p.issn, p.barcode, p.edition, p.weight, p.height,
              p.width, p.depth, p.year, p.pages, pbrs.name publisher, p.created_at, p.updated_at,
              p.deleted_at, p.cover, p.isbn, p.issn, p.barcode, 
              s.id as sku, s.seller_id as seller_id, s.price,
              (CASE WHEN s.is_new is not null and s.is_new = 't' THEN 1 ELSE 0 END) new, 
              (CASE WHEN s.is_new is not null and s.is_new = 'f' THEN 1 ELSE 0 END) used,
               s.quantity, s.created_at sku_created_at
            FROM books b
            left join publications p on p.book_id = b.id
            left join skus s on s.publication_id = p.id
            left join publishers pbrs on pbrs.id = p.publisher_id
            WHERE md5(concat(b.id, p.id, s.id))='${dih.delta.id}'"
     deltaQuery="SELECT md5(concat(b.id, p.id, s.id)) as id
            FROM books b
            left join publications p on p.book_id = b.id
            left join skus s on s.publication_id = p.id
            left join publishers pbrs on pbrs.id = p.publisher_id
            WHERE s.updated_at &gt; '${dih.last_index_time}' or p.updated_at &gt; '${dih.last_index_time}' or b.updated_at &gt; '${dih.last_index_time}'"
      >

        <entity name="author" pk="book_id" dataSource="library"
          query="select full_name as author_name from authors a
          join authors_books ab on a.id = ab.author_id where ab.book_id = ${sku.book_id}"
          deltaQuery="select ab.book_id from authors a
          join authors_books ab on a.id = ab.author_id where a.updated_at &gt; '${dih.last_index_time}'"
          parentDeltaQuery="select id from books where id='${author.book_id}'"
        >
          <field name="authors" column="author_name"/>
        </entity>

        <entity name="seller" pk="sku_id" dataSource="evmain"
          query="select u.nome, coalesce(u.cidade, l.cidade) as cidade, coalesce(u.estado, l.uf) as estado from usuarios u
           left join localidades l on u.cidade_id = l.location_id
           where u.user_id = '${sku.seller_id}'"
        >
          <field name="seller_name" column="nome"/>
          <field name="seller_city" column="cidade"/>
          <field name="seller_state" column="estado"/>
        </entity>
    </entity>


  </document>
</dataConfig>
